import{f as e,h as a,aV as s,b8 as t,a7 as l,b9 as i,z as n,bn as o,bj as r,aX as u,a3 as c,q as d,i as p,aZ as m,x as v,cH as f,ba as b,cU as h,C as _,D as g,j as x,c as k,o as y,a as w,b as N,G as A,B as F,w as j,d as S,t as $,E as T,R as C,F as E,r as I,e as R,b6 as z,H as V,b5 as P,n as U,cW as B,T as L,I as M,bp as H,cx as W,bb as O,bc as D,bd as G,be as q,bg as J,bh as K,bi as Q,b2 as X,b3 as Z}from"./BArbQupS.js";import{g as Y,_ as ee}from"./Kut759gw.js";import{E as ae}from"./DiUQ5gHK.js";import{_ as se}from"./C5oUYSqU.js";import{u as te,a as le}from"./BLxBA-tL.js";import"./RPgn-SFc.js";import"./BDaXgDLK.js";import"./F5y5-Ggc.js";import"./0yU0kwPB.js";import"./DYashxqB.js";import"./nQdZ39ta.js";import"./I2iqTsxw.js";import"./DfNTDuPk.js";import"./C0-q3wA8.js";const ie={class:"flex justify-between items-center mt-10px pr-15px"},ne=["infinite-scroll-disabled"],oe={class:"pr-10px pb-20px"},re={class:"flex-[1.5] flex items-center"},ue={class:"ml-6px"},ce={class:"flex"},de={class:"color-[var(--d-F5F5F5-l-333)]"},pe={class:"mt-2px color-[var(--d-999-l-666)]"},me={class:"flex-1 flex flex-col items-end"},ve={class:"flex-1 flex justify-end"},fe={key:1,class:"color-[var(--d-EAECEF-l-333)]"},be={key:0,class:"color-#959a9f text-12px text-center"},he=e({__name:"positionsTable",props:{height:{type:[Number,String],default:370}},setup(e){const{t:he}=a(),_e=s(),ge=t(),xe=l(),ke=te(),ye=le(),we=i();n((()=>_e.wsResult[X.PRICEV2]),(e=>{const a={};e.prices.forEach((e=>{a[e.token+"-"+e.chain]=e})),Ue.value=Ue.value.map((e=>{const s=a[e.index];if(s&&s.uprice>0){const a="--"===e.total_profit||0===Number(e.total_profit),t=new c(e.balance||0).times(s.uprice||0);if(a)return{...e,current_price_usd:s.uprice,balance_usd:t.toNumber()};{const a=new c(e.balance_usd||0).minus(e.total_profit||0),l=t.minus(a),i=new c(s.uprice||0).minus(e.average_purchase_price_usd||0).div(e.average_purchase_price_usd);return i.toNumber()<-1||Number(e.average_purchase_price_usd)<0?e:{...e,current_price_usd:s.uprice,balance_usd:t.toNumber(),total_profit:l.toFixed(),total_profit_ratio:i.toFixed()}}}return e})),h(Ue)})),n((()=>_e.wsResult[X.ASSET]),(e=>{var a;if(e.swap){const a="So11111111111111111111111111111111111111112"===e.swap.token||e.swap.token===f?f:e.swap.token,s=e.swap.chain,t=e.swap.type;if(a&&s){const l=Ue.value.findIndex((e=>e.token===a&&e.chain===s)),i="0"===t,n="0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"===a,o=Ue.value[l].balance;l>-1&&(i?n?Ne(a,s):(Ue.value[l].balance=Number(o)+Number(e.swap.amount),h(Ue)):n?Ne(a,s):Number(o)===Number(e.swap.amount)?(Ue.value.splice(l,1),h(Ue)):(Ue.value[l].balance=Number(o)-Number(e.swap.amount),h(Ue)))}}else if(e.transfer){const s=e.transfer.chain,t=e.transfer.token,l=e.transfer.type;if(t&&s){const i=Ue.value.findIndex((e=>e.token===t&&e.chain===s)),n="0"===l;if(i>-1){const s=Ue.value[i],t=Number(s.balance),l=s.current_price_usd,o=new c(t).plus(n?e.transfer.amount:-(null==(a=e.transfer)?void 0:a.amount)),r=o.multipliedBy(l);s.balance=o.toString(),s.balance_usd=r.toNumber(),h(Ue)}}}}));const Ne=o((function(e,a){const s=xe.getWalletAddress(a);s&&r({chain:a,walletAddress:s,tokens:[e]}).then((s=>{Ue.value=Ue.value.map((t=>t.token===e&&t.chain===a?{...t,balance:s[0].balance,balance_usd:new c(s[0].balance||0).times(t.current_price_usd||0).toNumber()}:{...t}))}))}),1e3,!1,!0);function Ae(){Pe.value.pageNo=1,Pe.value.finished=!1}let Fe=[];xe.userInfo&&(Fe=xe.userInfo.addresses.map((({address:e,chain:a})=>e+"-"+a)));const je=d({hide_risk:1,hide_small:0,user_ids:Fe}),Se=d({}),$e=e,Te=p((()=>Number($e.height)-110)),Ce=m("scrollContainerRef"),Ee=Z((()=>{const{value:e}=Ce;e&&e.scrollHeight<=e.clientHeight&&!Pe.value.finished&&Be()}),200);n(Te,Ee);const Ie=u({sortBy:void 0,activeSort:0}),Re={"-1":"asc",1:"desc"},ze=p((()=>({sort_dir:Re[Ie.value.activeSort],sort:Ie.value.sortBy}))),Ve=p((()=>[{label:`${he("token")}/${he("balance1")}`,value:"balance_usd",flex:"flex-[1.5]",sort:!0},{label:he("profit2"),value:"total_profit",flex:"flex-1 justify-end",sort:!0},{label:"",value:"",flex:"flex-1 justify-end",sort:!1}])),Pe=u({finished:!1,loading:!1,pageNo:1,pageSize:10}),Ue=u([]);async function Be(){try{Pe.value.loading=!0;const e=Pe.value.pageNo,a=await Y({pageNO:Pe.value.pageNo,pageSize:Pe.value.pageSize,...je.value,...ze.value});if(Array.isArray(null==a?void 0:a.data)&&a.data.length>0){if(1===e)Ue.value=a.data.map((e=>{var a;return{...e,index:e.token===f?(null==(a=b(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}}));else{const e=a.data.filter((e=>Ue.value.every((a=>a.index!==`${e.token}-${e.chain}`)))).map((e=>{var a;return{...e,index:e.token===f?(null==(a=b(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}}));Ue.value=Ue.value.concat(e)}Pe.value.finished=a.data.length<Pe.value.pageSize,Pe.value.finished||Pe.value.pageNo++}else 1===Pe.value.pageNo&&(Ue.value=[]);ye.setMultiPriceParams("positions",Ue.value.map((e=>e.token+"-"+e.chain))),ye.sendPriceWs()}catch(e){}finally{Pe.value.loading=!1,h(Pe)}}async function Le(e){if(!O())return;if(!e.token)return;const a=xe.getWalletAddress(e.chain);if(a)try{Se.value[e.index]=!0;const s=(await r({chain:e.chain,tokens:[e.token],walletAddress:a}))[0];s&&(e.balance=s.balance||0,e.balance_usd=new c(s.balance||0).times(e.current_price_usd||0).toNumber(),e.decimals=s.decimals||e.decimals);const t=s.balance||0;if(!t)return void D({title:"Error",type:"error",message:s("insufficientBalance")});await ke.checkApproveAndApprove({chain:e.chain,token:e.token,owner:a}),function(e,a){var s;if(!O())return;if(new c(e||0).lte(0))return void D({title:"Error",type:"error",message:he("amountMustG0")});const t=null==(s=new c(e||0).toFixed().match(new RegExp(`[0-9]*(\\.[0-9]{0,${a.decimals||18}})?`)))?void 0:s[0];if((Number(t)||0)<=0)return void D({title:"Error",type:"error",message:he("amountTooSmall")});Se.value[a.index]=!0,async function(e,a){var s,t,l;const i="solana"===a.chain,{botSettings:o}=ge,r=null==(s=null==o?void 0:o[a.chain])?void 0:s.selected,u=null==(t=null==o?void 0:o[a.chain])?void 0:t[r];if(i&&(null==u?void 0:u.mev)&&!(await xe.getBundleAvailable()))return void(Se.value[a.index]=!1);const{gasTip1List:d,gasTip2List:p}=G(q().gasTip,"solana"),m=(null==u?void 0:u.mev)?d:p,v=(null==u?void 0:u.mev)?null==u?void 0:u.gas[0]:null==(l=null==u?void 0:u.gas)?void 0:l[1];let b={};if(i){let e=(null==v?void 0:v.customFee)||(null==m?void 0:m[null==v?void 0:v.level])||"0.002";(null==u?void 0:u.mev)&&new c(e).lt("0.002")&&(e="0.002"),b.priorityFee=new c(e).times(10**9).toFixed(0)}else{const e=0===Number(null==v?void 0:v.customFee)?"0":(null==v?void 0:v.customFee)||(null==m?void 0:m[null==v?void 0:v.level])||"3";b.gasTip=Number(new c(e).times(10**9).toFixed(0)),b.contractType=0,b.chain=a.chain}const h={solana:"sol",ton:"TON"}[a.chain]||f,_=(null==u?void 0:u.slippage)||"9",g=xe.getWalletAddress(a.chain);if(!g)return;b={...b,batchId:Date.now().toString(),swapList:[{creatorAddress:g,inAmount:new c(e||0).times(10**a.decimals||0).toFixed(0)}],inTokenAddress:a.token,outTokenAddress:h,swapType:2,isPrivate:(null==u?void 0:u.mev)||!1,slippage:"auto"!==_?Number(new c(_).times(100).toFixed(0)):900};(i?J(b):K(b)).then((e=>function(e,a,s){if(e){let e=setTimeout((()=>{D({type:"success",message:he("transactionsSubmitted")}),we.placeOrderUpdate++,Se.value[s]=!1}),500);const t=n((()=>_e.wsResult.tgbot),(l=>{var i,n,o,r;l.batchId===a&&(e&&(clearTimeout(e),e=null),we.placeOrderSuccess++,(null==(n=null==(i=null==l?void 0:l.txList)?void 0:i[0])?void 0:n.success)?(D({type:"success",message:he("tradeSuccess")}),t()):(Q((null==(r=null==(o=null==l?void 0:l.txList)?void 0:o[0])?void 0:r.failMessage)||"swap error"),t()),Se.value[s]=!1)}))}}(e,b.batchId,a.index))).catch((e=>{Q(e||"swap error"),Se.value[a.index]=!1}))}(e,a)}(t,e)}finally{Se.value[e.index]=!1}}return v((()=>{Be()})),n((()=>[ze.value,je.value.hide_risk,je.value.hide_small,xe.evmAddress]),(()=>{Ae(),Be()})),(e,a)=>{const s=T,t=ee,l=z,i=V,n=L,o=R,r=H,u=ae,c=W,d=g;return _((y(),k("div",null,[w("div",ie,[N(s,{modelValue:x(je).hide_risk,"onUpdate:modelValue":a[0]||(a[0]=e=>x(je).hide_risk=e),class:"ml-12px",style:{marginRight:0},size:"small","true-value":1,"false-value":0},{default:j((()=>[S($(e.$t("hideRiskTokenShort")),1)])),_:1},8,["modelValue"]),N(s,{modelValue:x(je).hide_small,"onUpdate:modelValue":a[1]||(a[1]=e=>x(je).hide_small=e),size:"small","true-value":1,"false-value":0},{default:j((()=>[S($(e.$t("hideSmallAssets1")+"<1USD"),1)])),_:1},8,["modelValue"]),x(xe).evmAddress?(y(),A(t,{key:0,userIds:x(je).user_ids,"onUpdate:userIds":[a[2]||(a[2]=e=>x(je).user_ids=e),a[3]||(a[3]=e=>{Ae(),Be()})]},null,8,["userIds"])):F("",!0)]),N(se,{sort:x(Ie),"onUpdate:sort":a[4]||(a[4]=e=>C(Ie)?Ie.value=e:null),columns:x(Ve)},null,8,["sort","columns"]),N(u,{height:x(Te)},{default:j((()=>[_((y(),k("div",{ref_key:"scrollContainerRef",ref:Ce,"infinite-scroll-disabled":x(Pe).finished||x(Pe).loading,"infinite-scroll-distance":"200","infinite-scroll-delay":10,"infinite-scroll-immediate":!1},[w("div",oe,[(y(!0),k(E,null,I(x(Ue),((a,s)=>(y(),A(o,{key:s,class:"text-12px flex justify-between pl-10px py-10px cursor-pointer hover:bg-[var(--d-1A1A1A-l-F2F2F2)]",to:`/token/${a.index}`},{default:j((()=>[w("div",re,[N(l,{row:a},null,8,["row"]),w("div",ue,[w("div",ce,[w("span",de,$(a.symbol),1),a.risk_score>55||a.risk_level<0?(y(),A(i,{key:0,name:"custom:danger",class:"font-14 ml-2px color-#F72121"})):F("",!0)]),w("div",pe,[0===a.balance?(y(),k(E,{key:0},[S("$0")],64)):"--"===a.balance?(y(),k(E,{key:1},[S("--")],64)):(y(),k(E,{key:2},[S($(("formatNumber"in e?e.formatNumber:x(P))(a.balance,2))+"("+$("$"+("formatNumber"in e?e.formatNumber:x(P))(a.balance_usd||0,2))+") ",1)],64))])])]),w("div",me,[w("div",{class:U(("getColorClass"in e?e.getColorClass:x(B))(a.total_profit))},[0===Number(a.total_profit)?(y(),k(E,{key:0},[S("0")],64)):"--"===a.total_profit?(y(),k(E,{key:1},[S("--")],64)):(y(),k(E,{key:2},[S($(Number(a.total_profit)>0?"$":"-$")+$(("formatNumber"in e?e.formatNumber:x(P))(Math.abs(Number(a.total_profit)),2)),1)],64))],2),w("div",{class:U(("getColorClass"in e?e.getColorClass:x(B))(a.total_profit_ratio))},[0===Number(a.total_profit_ratio)?(y(),k(E,{key:0},[S("0")],64)):"--"===a.total_profit_ratio?(y(),k(E,{key:1},[S("--")],64)):(y(),k(E,{key:2},[S($(Number(a.total_profit_ratio)>0?"+":"-")+$(("formatNumber"in e?e.formatNumber:x(P))(Math.abs(100*Number(a.total_profit_ratio)),2))+"% ",1)],64))],2)]),w("div",ve,[x(xe).evmAddress&&"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"!==a.token?(y(),A(n,{key:0,size:"small",loading:x(Se)[a.index],class:"[--el-border:0] [&&]:[--el-button-bg-color:--d-222-l-F2F2F2] [&&]:font-normal",style:{padding:"4px"},onClick:M((e=>Le(a)),["stop","prevent"])},{default:j((()=>[S($(e.$t("closePosition")),1)])),_:2},1032,["loading","onClick"])):(y(),k("span",fe,"--"))])])),_:2},1032,["to"])))),128)),0!==x(Ue).length||x(Pe).loading?F("",!0):(y(),A(r,{key:0}))]),x(Pe).loading&&1!==x(Pe).pageNo?(y(),k("div",be,$(e.$t("loading")),1)):F("",!0)],8,ne)),[[c,Be]])])),_:1},8,["height"])])),[[d,x(Pe).loading&&1===x(Pe).pageNo]])}}});export{he as default};
